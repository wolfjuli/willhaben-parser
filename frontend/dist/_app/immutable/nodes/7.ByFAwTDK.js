import{t as template,a as append,e as text,c as comment}from"../chunks/CYEyA5r_.js";import{m as hydrating,o as hydrate_next,ac as is_runes,l as block,aJ as is_promise,ag as UNINITIALIZED,a2 as internal_set,a5 as source,a4 as mutable_source,I as queue_micro_task,az as set_active_effect,ay as set_active_reaction,aK as set_component_context,b as component_context,_ as resume_effect,q as branch,$ as pause_effect,aD as flush_sync,v as hydrate_node,p as push,c as child,g as get,C as state,r as reset,s as sibling,a as pop,t as template_effect,D as set,d as derived,n as next,f as first_child}from"../chunks/B17x10Mu.js";import{a as prop,i as if_block,p as proxy,s as spread_props}from"../chunks/f5cgzvLy.js";import{b as bind_value,e as each,i as index,m as mergedAttributes}from"../chunks/DKBOVYmS.js";import{c as createFunction,F as FunctionsStore}from"../chunks/BQoige-h.js";import{S as ScriptsStore}from"../chunks/zNrkdR33.js";import{r as randomName,F as Function}from"../chunks/BpNj1Hs_.js";import{s as set_text}from"../chunks/BVnXvrre.js";import{r as remove_input_defaults,b as set_attribute,L as ListingsStore,e as ListingDb}from"../chunks/7tyWikOm.js";import{d as delegate,c as autofocus}from"../chunks/CF65HRtN.js";import{D as Dropdown}from"../chunks/xkPIaZ54.js";import"../chunks/DwEdY2hh.js";import{i as init}from"../chunks/C12z8DQz.js";import{L as ListingDetail}from"../chunks/B28m_p6u.js";const PENDING=0,THEN=1,CATCH=2;function await_block(r,e,t,i,s){hydrating&&hydrate_next();var c=r,n=is_runes(),_=component_context,a=UNINITIALIZED,u,d,g,l=(n?source:mutable_source)(void 0),o=(n?source:mutable_source)(void 0),p=!1;function m(v,h){p=!0,h&&(set_active_effect(x),set_active_reaction(x),set_component_context(_));try{v===THEN&&i&&(d?resume_effect(d):d=branch(()=>i(c,l))),v!==PENDING&&u&&pause_effect(u,()=>u=null),v!==THEN&&d&&pause_effect(d,()=>d=null),v!==CATCH&&g&&pause_effect(g,()=>g=null)}finally{h&&(set_component_context(null),set_active_reaction(null),set_active_effect(null),flush_sync())}}var x=block(()=>{if(a!==(a=e())){if(is_promise(a)){var v=a;p=!1,v.then(h=>{v===a&&(internal_set(l,h),m(THEN,!0))},h=>{if(v===a)throw internal_set(o,h),m(CATCH,!0),o.v}),hydrating||queue_micro_task(()=>{p||m(PENDING,!0)})}else internal_set(l,a),m(THEN,!1);return()=>a=UNINITIALIZED}});hydrating&&(c=hydrate_node)}var on_focusout=(r,e,t)=>{set(e,!1),t()},on_focusin=r=>r.target.select(),on_keydown=(r,e,t)=>{r.key==="Enter"&&(set(e,!1),t())},root_1$1=template('<input type="text">'),on_click$1=(r,e)=>set(e,!0),root_2$3=template("<span> </span>"),root$6=template('<div class="grid"><div><!></div> <div><!></div></div>');function CustomScript(r,e){push(e,!0);let t=prop(e,"script",7);function i(){t().name?ScriptsStore.update(t()):ScriptsStore.delete(t())}let s=state(!1);var c=root$6(),n=child(c),_=child(n);{var a=l=>{var o=root_1$1();remove_input_defaults(o),o.__focusout=[on_focusout,s,i],o.__focusin=[on_focusin],o.__keydown=[on_keydown,s,i],autofocus(o,!0),template_effect(()=>set_attribute(o,"placeholder",t().name)),bind_value(o,()=>t().name,p=>t().name=p),append(l,o)},u=l=>{var o=root_2$3();o.__click=[on_click$1,s];var p=child(o,!0);reset(o),template_effect(()=>set_text(p,t().name)),append(l,o)};if_block(_,l=>{get(s)?l(a):l(u,!1)})}reset(n);var d=sibling(n,2),g=child(d);Dropdown(g,{nameSelector:l=>l.label,onchange:l=>(t().attributeId=l.id,i(),!1),get preSelected(){return t().attributeId},get values(){return e.attributes}}),reset(d),reset(c),append(r,c),pop()}delegate(["focusout","focusin","keydown","click"]);var root$5=template('<div class="grid"><div>New Script on attribute:</div> <div><!></div></div>');function CreateCustomScript(r,e){push(e,!0);function t(){return{id:-1,name:randomName(),attributeId:-1}}function i(){ScriptsStore.create(get(c)),set(c,proxy(t()))}function s(u){return get(c).attributeId=u.id,i(),!0}let c=state(proxy(t()));var n=root$5(),_=sibling(child(n),2),a=child(_);Dropdown(a,{nameSelector:u=>u.label,onchange:s,get values(){return e.attributes}}),reset(_),reset(n),template_effect(()=>set_attribute(n,"id",`fun${get(c).id??"-new"}`)),append(r,n),pop()}var root$4=template('<div><span class="svelte-bf09ua"> </span> <small> </small></div>');function FunctionValue(r,e){var t=root$4(),i=child(t),s=child(i,!0);reset(i);var c=sibling(i,2),n=child(c,!0);reset(c),reset(t),template_effect(()=>{set_text(s,e.name),set_text(n,e.value??"")}),append(r,t)}function transformListing(listing,attributes,functions){return attributes.reduce((lst,attr)=>{const fun=attr.functionId?eval(functions[attr.functionId].function):()=>lst[attr.normalized];return lst[attr.normalized]=fun(lst[attr.normalized],lst),lst},{...listing})}var on_click=(r,e,t)=>e(get(t)),root_2$2=template("â†“ <br> <button>X</button> <!> <br>",1),root$3=template('<details><summary>Function steps <!></summary> <div class="text-center"><!> <!> <!></div></details>');function ScriptFunctions($$anchor,$$props){push($$props,!0);let attribute=derived(()=>$$props.attributes.find(r=>r.id===$$props.script.attributeId)),attributeValue=derived(()=>{var r,e;return(e=(r=$$props.listing?transformListing($$props.listing,$$props.attributes,$$props.functions):void 0)==null?void 0:r[get(attribute).normalized])==null?void 0:e.base}),functionValues=derived(()=>{var r,e;return((e=$$props.script.functions)==null?void 0:e.reduce((acc,fId)=>{const fun=$$props.functions[fId.functionId];if(!fun)return acc;let exec,value;try{exec=fun!=null&&fun.function?eval(fun.function):void 0,value=$$props.listing&&exec?exec(acc[acc.length-1].value,$$props.listing):[]}catch(t){console.error(`Error during execution of function '${fun.name}' on '${get(attribute).normalized}'`,t)}return[...acc,{scriptId:$$props.script.id,functionId:fun.id,ord:fId.ord,name:fun.name,value}]},[{name:(r=get(attribute))==null?void 0:r.normalized,value:get(attributeValue),ord:-1,functionId:-1,scriptId:-1}]))??[]});function addFunction(r){let e=$$props.script.functions[$$props.script.functions.length-1].ord+1,t={scriptId:$$props.script.id,functionId:r.id,ord:e};ScriptsStore.createScriptFunction(t)}function removeFunction(r){ScriptsStore.deleteScriptFunction(r)}var details=root$3(),summary=child(details),node=sibling(child(summary));{var consequent=r=>{var e=text();template_effect(()=>set_text(e,`(${get(functionValues)[get(functionValues).length-1].value??""} Points)`)),append(r,e)};if_block(node,r=>{$$props.listing&&get(functionValues)&&r(consequent)})}reset(summary);var div=sibling(summary,2),node_1=child(div);FunctionValue(node_1,spread_props(()=>get(functionValues)[0]));var node_2=sibling(node_1,2);each(node_2,17,()=>get(functionValues).slice(1),index,(r,e)=>{next();var t=root_2$2(),i=sibling(first_child(t),3);i.__click=[on_click,removeFunction,e];var s=sibling(i,2);FunctionValue(s,spread_props(()=>get(e))),next(2),append(r,t)});var node_4=sibling(node_2,2);const expression=derived(()=>Object.values($$props.functions));Dropdown(node_4,{nameSelector:r=>r.name,onchange:addFunction,get values(){return get(expression)}}),reset(div),reset(details),append($$anchor,details),pop()}delegate(["click"]);var root_2$1=template("<option> </option>"),root$2=template('<div role="group"><input type="search"> <button>X</button></div> <select size="5"></select>',1);function ListingSearch(r,e){push(e,!0);function t(a){var d,g;const u=+(((d=a==null?void 0:a.explicitOriginalTarget)==null?void 0:d.value)??((g=a==null?void 0:a.target)==null?void 0:g.value)??0);u?ListingDb.get(u).then(l=>e.onselect(l)):e.onselect(void 0)}var i=root$2(),s=first_child(i),c=child(s);remove_input_defaults(c),c.__keyup=()=>{ListingsStore.value.searchParams.searchString===""&&t(void 0)};var n=sibling(c,2);n.__click=()=>{ListingsStore.value.searchParams.searchString="",t(void 0)},reset(s);var _=sibling(s,2);_.__click=t,each(_,21,()=>e.sorted,index,(a,u)=>{var d=comment(),g=first_child(d);await_block(g,()=>ListingDb.get(get(u)),null,(l,o)=>{var p=root_2$1(),m={},x=child(p,!0);reset(p),template_effect(v=>{m!==(m=get(u))&&(p.value=(p.__value=get(u))==null?"":get(u)),set_text(x,v)},[()=>`${get(o).willhabenId} - ${get(o).heading.base.slice(0,30)} - ${get(o).points} - ${get(o).priceForDisplay.base}`]),append(l,p)}),append(a,d)}),reset(_),bind_value(c,()=>ListingsStore.value.searchParams.searchString,a=>ListingsStore.value.searchParams.searchString=a),append(r,i),pop()}delegate(["keyup","click"]);var root$1=template('<div class="grid"><div><input type="text" placeholder="New Function..."></div></div>');function CreateFunction(r,e){push(e,!1);function t(n){createFunction({id:-1,name:n,function:"(val, row) => val"})}init();var i=root$1(),s=child(i),c=child(s);c.__keyup=n=>{n.key==="Enter"&&(t(n.target.value),n.target.value="")},reset(s),reset(i),append(r,i),pop()}delegate(["keyup"]);var root_2=template("<!> <!> <hr>",1),root_1=template("<h3>Scripts</h3> <!> <hr> <!>",1),root_4=template("<h3>Functions</h3> <!> <hr> <!>",1),root=template('<div class="grid"><div><!></div> <div><h3>Example Listing</h3> <!> <!></div></div> <div class="grid"><div><!></div></div>',1);function _page(r,e){push(e,!0);const t=derived(()=>FunctionsStore.value),i=derived(()=>ScriptsStore.value),s=derived(()=>{var f;return((f=mergedAttributes().value)==null?void 0:f.toSorted((b,$)=>b.normalized.localeCompare($.normalized)))??[]}),c=derived(()=>ListingsStore.value.sorting??[]);let n=state(void 0),_=derived(()=>e.data.configuration);var a=root(),u=first_child(a),d=child(u),g=child(d);{var l=f=>{var b=root_1(),$=sibling(first_child(b),2);CreateCustomScript($,{get attributes(){return get(s)}});var y=sibling($,4);each(y,17,()=>Object.keys(get(i)),index,(k,S)=>{var I=root_2(),F=first_child(I);CustomScript(F,{get script(){return get(i)[get(S)]},get attributes(){return get(s)}});var D=sibling(F,2);ScriptFunctions(D,{get script(){return get(i)[get(S)]},get attributes(){return get(s)},get functions(){return get(t)},get listing(){return get(n)}}),next(2),append(k,I)}),append(f,b)};if_block(g,f=>{get(i)&&f(l)})}reset(d);var o=sibling(d,2),p=sibling(child(o),2);ListingSearch(p,{get sorted(){return get(c)},onselect:f=>{set(n,proxy(f))}});var m=sibling(p,2);{var x=f=>{ListingDetail(f,{get listing(){return get(n)},get attributes(){return get(s)},get configuration(){return get(_)}})};if_block(m,f=>{get(n)&&f(x)})}reset(o),reset(u);var v=sibling(u,2),h=child(v),N=child(h);{var L=f=>{var b=root_4(),$=sibling(first_child(b),2);CreateFunction($,{});var y=sibling($,4);each(y,17,()=>Object.keys(get(t)),index,(k,S)=>{Function(k,{get fun(){return get(t)[get(S)]}})}),append(f,b)};if_block(N,f=>{get(t)&&f(L)})}reset(h),reset(v),append(r,a),pop()}export{_page as component};
