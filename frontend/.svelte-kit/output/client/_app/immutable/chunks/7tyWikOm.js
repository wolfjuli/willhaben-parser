var it=Object.defineProperty;var G=e=>{throw TypeError(e)};var at=(e,t,s)=>t in e?it(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var v=(e,t,s)=>at(e,typeof t!="symbol"?t+"":t,s),R=(e,t,s)=>t.has(e)||G("Cannot "+s);var h=(e,t,s)=>(R(e,t,"read from private field"),s?s.call(e):t.get(e)),y=(e,t,s)=>t.has(e)?G("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),$=(e,t,s,i)=>(R(e,t,"write to private field"),i?i.call(e,s):t.set(e,s),s);import{m as j,aj as rt,aF as nt,aG as ct,aH as ot,M,ay as W,az as K,aA as lt,U as ut,C as H,g as E,D as Y,e as Q,d as ft,i as F}from"./B17x10Mu.js";import{f as dt,g as ht,j as gt,d as vt,c as yt,n as _t,k as wt}from"./CF65HRtN.js";import{p as T}from"./f5cgzvLy.js";function X(e){var t,s,i="";if(typeof e=="string"||typeof e=="number")i+=e;else if(typeof e=="object")if(Array.isArray(e)){var a=e.length;for(t=0;t<a;t++)e[t]&&(s=X(e[t]))&&(i&&(i+=" "),i+=s)}else for(s in e)e[s]&&(i&&(i+=" "),i+=s);return i}function bt(){for(var e,t,s=0,i="",a=arguments.length;s<a;s++)(e=arguments[s])&&(t=X(e))&&(i&&(i+=" "),i+=t);return i}function pt(e){return typeof e=="object"?bt(e):e??""}function Mt(e){if(j){var t=!1,s=()=>{if(!t){if(t=!0,e.hasAttribute("value")){var i=e.value;D(e,"value",null),e.value=i}if(e.hasAttribute("checked")){var a=e.checked;D(e,"checked",null),e.checked=a}}};e.__on_r=s,nt(s),dt()}}function Dt(e,t){var s=e.__attributes??(e.__attributes={});s.value===(s.value=t??void 0)||e.value===t&&(t!==0||e.nodeName!=="PROGRESS")||(e.value=t??"")}function Pt(e,t){var s=e.__attributes??(e.__attributes={});s.checked!==(s.checked=t??void 0)&&(e.checked=t)}function St(e,t){t?e.hasAttribute("selected")||e.setAttribute("selected",""):e.removeAttribute("selected")}function D(e,t,s,i){var a=e.__attributes??(e.__attributes={});j&&(a[t]=e.getAttribute(t),t==="src"||t==="srcset"||t==="href"&&e.nodeName==="LINK")||a[t]!==(a[t]=s)&&(t==="style"&&"__styles"in e&&(e.__styles={}),t==="loading"&&(e[ct]=s),s==null?e.removeAttribute(t):typeof s!="string"&&V(e).includes(t)?e[t]=s:e.setAttribute(t,s))}function Ct(e,t,s){var i=lt,a=ut;let r=j;j&&M(!1),W(null),K(null);try{(z.has(e.nodeName)||!customElements||customElements.get(e.tagName.toLowerCase())?V(e).includes(t):s&&typeof s=="object")?e[t]=s:D(e,t,s==null?s:String(s))}finally{W(i),K(a),r&&M(!0)}}function Lt(e,t,s,i,a=!1,r=!1,J=!1){let O=j&&r;O&&M(!1);var u=t||{},L=e.tagName==="OPTION";for(var A in t)A in s||(s[A]=null);s.class&&(s.class=pt(s.class)),i!==void 0&&(s.class=s.class?s.class+" "+i:i);var Z=V(e),tt=e.__attributes??(e.__attributes={});for(const n in s){let c=s[n];if(L&&n==="value"&&c==null){e.value=e.__value="",u[n]=c;continue}var U=u[n];if(c!==U){u[n]=c;var m=n[0]+n[1];if(m!=="$$"){if(m==="on"){const f={},b="$$"+n;let l=n.slice(2);var q=wt(l);if(ht(l)&&(l=l.slice(0,-7),f.capture=!0),!q&&U){if(c!=null)continue;e.removeEventListener(l,u[b],f),u[b]=null}if(c!=null)if(q)e[`__${l}`]=c,vt([l]);else{let et=function(st){u[n].call(this,st)};u[b]=gt(l,e,et,f)}else q&&(e[`__${l}`]=void 0)}else if(n==="style"&&c!=null)e.style.cssText=c+"";else if(n==="autofocus")yt(e,!!c);else if(!r&&(n==="__value"||n==="value"&&c!=null))e.value=e.__value=c;else if(n==="selected"&&L)St(e,c);else{var d=n;a||(d=_t(d));var B=d==="defaultValue"||d==="defaultChecked";if(c==null&&!r&&!B)if(tt[n]=null,d==="value"||d==="checked"){let f=e;const b=t===void 0;if(d==="value"){let l=f.defaultValue;f.removeAttribute(d),f.defaultValue=l,f.value=f.__value=b?l:null}else{let l=f.defaultChecked;f.removeAttribute(d),f.defaultChecked=l,f.checked=b?l:!1}}else e.removeAttribute(n);else B||Z.includes(d)&&(r||typeof c!="string")?e[d]=c:typeof c!="function"&&D(e,d,c)}n==="style"&&"__styles"in e&&(e.__styles={})}}}return O&&M(!0),u}var z=new Map;function V(e){var t=z.get(e.nodeName);if(t)return t;z.set(e.nodeName,t=[]);for(var s,i=e,a=Element.prototype;a!==i;){s=ot(i);for(var r in s)s[r].set&&t.push(r);i=rt(i)}return t}var I;class kt{constructor(){y(this,I,H())}get value(){return E(h(this,I))}set value(t){Y(h(this,I),T(t))}}I=new WeakMap;class At extends kt{constructor(s,i){super();v(this,"key","");this.key=s;{const a=localStorage.getItem(s);this.value=a?this.deserialize(a):i()}Q(()=>{localStorage.setItem(this.key,this.serialize(this.value))})}serialize(s){return JSON.stringify(s)}deserialize(s){return JSON.parse(s)}}var p,N,C;const o=class o{constructor(){y(this,N,H(T({})));y(this,C,ft(()=>Object.values(o.instance.fetchingStores).reduce((t,s)=>t+s,0)))}get fetchingStores(){return E(h(this,N))}set fetchingStores(t){Y(h(this,N),T(t))}get value(){return E(h(this,C))}static get fetching(){return o.instance.value}static get instance(){return h(o,p)||$(o,p,new o),h(o,p)}static whileFetching(t,s){o.startFetching(t);let i;try{i=s()}finally{i?i.finally(()=>o.finishFetching(t)):o.finishFetching(t)}return i}static startFetching(t){o.instance.fetchingStores[t]=(o.instance.fetchingStores[t]??0)+1}static finishFetching(t){o.instance.fetchingStores[t]&&o.instance.fetchingStores[t]===1&&delete o.instance.fetchingStores[t]}};p=new WeakMap,N=new WeakMap,C=new WeakMap,y(o,p);let _=o;function jt(e){if(!e)return!1;const t=e;return t.id!==void 0&&t.willhabenId!==void 0}function It(e){if(!e||!e.listing||!e.md5)return!1;const t=e.listing;return t.id!==void 0&&t.willhabenId!==void 0}var S;const w=class w{constructor(){v(this,"db");v(this,"asyncInstance");const t=indexedDB.open("willhaben",3);this.asyncInstance=new Promise(s=>{t.onupgradeneeded=()=>{this.db=t.result;const i=this.db.createObjectStore("listings",{keyPath:"id"});i.createIndex("willhabenId","willhabenId",{unique:!1}),i.createIndex("heading","heading",{unique:!1}),this.db.createObjectStore("knownMd5",{keyPath:"id"}).createIndex("md5","md5",{unique:!0}),s(this)},t.onsuccess=()=>{this.db=t.result,s(this)}})}static get instance(){return h(w,S)||$(w,S,new w),h(w,S).asyncInstance}static async addAll(t){return this.instance.then(s=>{const i=s.db.transaction("listings","readwrite").objectStore("listings"),a=s.db.transaction("knownMd5","readwrite").objectStore("knownMd5");t.forEach(r=>{jt(r)?(i.delete(r.id),i.add(r)):It(r)?(i.delete(r.listing.id),i.add(r.listing),a.delete(r.listing.id),a.add({id:r.listing.id,md5:r.md5})):(a.delete(r.id),a.add(r))})})}static async get(t){return new Promise(async(s,i)=>{this.instance.then(a=>{const r=a.db.transaction("listings","readonly").objectStore("listings").get(t);r.onsuccess=()=>s(r.result),r.onerror=()=>i()})})}static async known(t){return new Promise(async(s,i)=>{let a=[],r=0;this.instance.then(J=>{t.map(O=>{const u=J.db.transaction("knownMd5","readonly").objectStore("knownMd5").get(O);u.onsuccess=()=>{var A;((A=u.result)==null?void 0:A.md5)?a=[...a,u.result.md5]:r++,a.length+r===t.length&&s(a)},u.onerror=()=>r++})})})}};S=new WeakMap,y(w,S);let P=w;var k;const g=class g extends At{constructor(){super("listingsStore",()=>({sorting:[],lastUpdate:new Date("2020-01-01"),searchParams:{viewAttributes:[],searchString:"",searchAttributes:[],sortCol:"points",sortDir:"DESC"}})),new Date().valueOf()-new Date(this.value.lastUpdate).valueOf()>1e4&&this.fetchSorting();let t=0;Q(()=>{this.value.searchParams.searchString,t&&clearTimeout(t),t=setTimeout(()=>{F(()=>this.fetchSorting()),clearTimeout(t),t=0},500)})}static get instance(){return h(this,k)||$(this,k,new g),h(this,k)}static get value(){return g.instance.value}fetchSorting(){_.whileFetching("fetchSorting",()=>{const t=this.value.searchParams,s=[...new Set([...t.searchAttributes,...t.viewAttributes])].join(",");fetch(`/api/rest/v1/listings/sorting?sortCol=${t.sortCol}&sortDir=${t.sortDir}&searchString=${t.searchString}&searchAttrs=${s}`).then(i=>i.json()).then(i=>{F(()=>this.value.lastUpdate=new Date),F(()=>this.value.sorting=i.map(a=>a.listingId))})})}fetch(t){return _.whileFetching("fetchListing",()=>F(()=>P.known(t).then(async s=>await fetch(`/api/rest/v1/listings/full?ids=${t.join(",")}&knownMd5=${s.join(",")}`)).then(s=>s.json()).then(async s=>{this.value.lastUpdate=new Date,await P.addAll(s.map(i=>({listing:i.listing,md5:i.md5})))})))}};k=new WeakMap,y(g,k),v(g,"createListingValue",t=>_.whileFetching("createListingValue",()=>fetch("/api/rest/v1/user_defined_attributes",{method:"post",body:JSON.stringify(t)}).then(()=>g.instance.fetch([t.listingId])))),v(g,"updateListingValue",t=>_.whileFetching("updateListingValue",()=>fetch("/api/rest/v1/user_defined_attributes",{method:"put",body:JSON.stringify(t)}).then(()=>g.instance.fetch([t.listingId])))),v(g,"deleteListingValue",t=>_.whileFetching("deleteListingValue",()=>fetch("/api/rest/v1/user_defined_attributes",{method:"delete",body:JSON.stringify(t)}).then(()=>g.instance.fetch([t.listingId]))));let x=g;export{_ as F,x as L,kt as W,St as a,D as b,Dt as c,Lt as d,P as e,Ct as f,Mt as r,Pt as s};
